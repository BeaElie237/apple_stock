name: Apple Stock ML Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    # Exécution automatique chaque lundi à 06h
    - cron: "0 6 * * 1"

env:
  PYTHON_VERSION: "3.10"
  HF_SPACE_NAME: "apple-stock-predictor"
  HF_USERNAME: ${{ secrets.HF_USERNAME }}

jobs:

# ==========================
# 1️⃣ COLLECTE DES DONNÉES
# ==========================
  data_collection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Download stock data
        run: |
          python src/ingestion.py

      - name: Upload raw data artifact
        uses: actions/upload-artifact@v4
        with:
          name: raw-data
          path: data/raw/

# ==========================
# 2️⃣ PRÉTRAITEMENT
# ==========================
  preprocessing:
    runs-on: ubuntu-latest
    needs: data_collection

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: raw-data
          path: data/raw/

      - name: Preprocess data
        run: |
          python src/preprocessing.py

      - uses: actions/upload-artifact@v4
        with:
          name: processed-data
          path: data/processed/

# ==========================
# 3️⃣ ENTRAÎNEMENT DES MODÈLES
# ==========================
  training:
    runs-on: ubuntu-latest
    needs: preprocessing

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: processed-data
          path: data/processed/

      - name: Train models (CNN & GRU)
        run: |
          python src/training.py

      - uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: models/

# ==========================
# 4️⃣ ÉVALUATION & SÉLECTION
# ==========================
  evaluation:
    runs-on: ubuntu-latest
    needs: training

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: trained-models
          path: models/

      - name: Evaluate and select best model
        run: |
          python src/evaluation.py

      - uses: actions/upload-artifact@v4
        with:
          name: best-model
          path: models/best_model.h5

# ==========================
# 5️⃣ DÉPLOIEMENT HUGGING FACE
# ==========================
  deploy_huggingface:
    runs-on: ubuntu-latest
    needs: evaluation

    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub Actions"

      - uses: actions/download-artifact@v4
        with:
          name: best-model
          path: models/

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git clone https://huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE_NAME}
          cp -r app/* ${HF_SPACE_NAME}/
          cp models/best_model.h5 ${HF_SPACE_NAME}/models/
          cd ${HF_SPACE_NAME}
          git add .
          git commit -m "Automated deployment from GitHub Actions"
          git push https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE_NAME}

# ==========================
# 6️⃣ PRÉDICTION & ALERTES
# ==========================
  prediction_and_alert:
    runs-on: ubuntu-latest
    needs: deploy_huggingface

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install -r requirements.txt

      - name: Run future prediction
        run: |
          python src/prediction.py

      - name: Send email alerts
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        run: |
          python src/notification.py
